<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amusement Park Day Planner</title>
    <style>
        :root {
            /* Disneyland-Inspired Palette */
            --magic-blue: #0051BA;
            --castle-blue: #4A90E2;
            --fantasy-purple: #8B5CF6;
            --pixie-pink: #EC4899;
            --mickey-red: #E31E24;
            --golden-magic: #FFB82E;
            --starlight-yellow: #FDE047;
            --enchanted-teal: #14B8A6;
            
            /* Neutrals */
            --fairy-cream: #FFF9F0;
            --castle-white: #FFFFFF;
            --midnight-navy: #1E293B;
            --royal-grey: #64748B;
            
            /* Functional */
            --border-magic: #E0E7FF;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-enchanted: 0 8px 24px rgba(139, 92, 246, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #E0E7FF, var(--fairy-cream));
            background-attachment: fixed;
            color: var(--midnight-navy);
            overflow-x: hidden;
        }

        header {
            background: #5287F1;
            padding: 0;
            text-align: center;
            box-shadow: var(--shadow-enchanted);
            border-bottom: 4px solid var(--golden-magic);
            height: 300px;
            overflow: hidden;
        }

        header .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        header .logo {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
        }

        header h1 {
            display: none;
        }

        header p {
            display: none;
        }

        .container {
            display: flex;
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
            gap: 2rem;
        }

        .left-panel {
            flex: 1;
            min-width: 300px;
        }

        .right-panel {
            flex: 2;
        }

        .section-title {
            color: var(--magic-blue);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        /* Filters */
        .filters {
            background: var(--castle-white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 1.5rem;
            border: 2px solid var(--border-magic);
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .filter-item label {
            cursor: pointer;
            font-size: 1rem;
        }

        /* Park Selector */
        .park-selector {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 2px solid var(--fantasy-purple);
            border-radius: 8px;
            background: var(--castle-white);
            color: var(--midnight-navy);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .park-selector:hover {
            border-color: var(--pixie-pink);
            box-shadow: 0 0 8px rgba(236, 72, 153, 0.3);
        }

        .park-selector:focus {
            outline: none;
            border-color: var(--magic-blue);
            box-shadow: 0 0 0 3px rgba(0, 81, 186, 0.2);
        }

        .park-info {
            padding: 0.5rem;
            background: var(--fairy-cream);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--royal-grey);
            border: 1px solid var(--border-magic);
        }

        /* Rides List */
        .rides-section {
            background: var(--castle-white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
            border: 2px solid var(--border-magic);
        }

        .rides-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .ride-card {
            background: linear-gradient(135deg, var(--castle-white), #F8F9FF);
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid var(--fantasy-purple);
            cursor: grab;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .ride-card.closed {
            opacity: 0.6;
            background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
            border-color: #ccc;
        }

        .ride-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
            border-color: var(--pixie-pink);
        }

        .ride-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .ride-card.hidden {
            display: none;
        }

        .ride-info {
            flex: 1;
        }

        .ride-name {
            font-weight: bold;
            color: var(--magic-blue);
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .ride-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
            font-size: 0.9rem;
        }

        .wait-time {
            background: var(--mickey-red);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.85rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .wait-time.short {
            background: var(--enchanted-teal);
            color: white;
        }

        .wait-time.medium {
            background: var(--golden-magic);
            color: var(--midnight-navy);
        }

        .wait-time.long {
            background: var(--mickey-red);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.open {
            background: var(--enchanted-teal);
            color: white;
        }

        .status-badge.closed {
            background: #999;
            color: white;
        }

        .ride-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .tag {
            background: var(--fantasy-purple);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .favorite-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 0.5rem;
        }

        .favorite-btn:hover {
            transform: scale(1.2);
        }

        .favorite-btn.active {
            color: var(--pixie-pink);
            filter: drop-shadow(0 2px 4px rgba(236, 72, 153, 0.4));
        }

        .favorite-btn.inactive {
            color: #ccc;
        }

        /* Schedule Blocks */
        .schedule-container {
            background: var(--castle-white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 1.5rem;
            border: 2px solid var(--border-magic);
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .schedule-block {
            background: linear-gradient(135deg, #F8F9FF, var(--fairy-cream));
            border: 3px dashed var(--fantasy-purple);
            border-radius: 12px;
            padding: 1rem;
            min-height: 200px;
        }

        .schedule-block.drag-over {
            background: var(--castle-white);
            border-color: var(--pixie-pink);
            border-style: solid;
            box-shadow: var(--shadow-enchanted);
            transform: scale(1.02);
        }

        .schedule-block-title {
            color: var(--magic-blue);
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .scheduled-rides {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .scheduled-ride {
            background: var(--castle-white);
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 4px solid var(--golden-magic);
            font-weight: 500;
            color: var(--midnight-navy);
            position: relative;
            padding-right: 2.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .scheduled-ride-delete {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--mickey-red);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            transition: all 0.2s ease;
            padding: 0;
            line-height: 1;
        }

        .scheduled-ride-delete:hover {
            background: #B71C1C;
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(227, 30, 36, 0.4);
        }

        /* Spinner Section */
        .spinner-section {
            background: var(--castle-white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-soft);
            text-align: center;
            border: 2px solid var(--border-magic);
        }

        .spinner-wheel {
            width: 200px;
            height: 200px;
            margin: 1.5rem auto;
            border-radius: 50%;
            background: conic-gradient(
                var(--golden-magic) 0deg 90deg,
                var(--pixie-pink) 90deg 180deg,
                var(--castle-blue) 180deg 270deg,
                var(--fantasy-purple) 270deg 360deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 8px solid var(--magic-blue);
            box-shadow: var(--shadow-enchanted);
            transition: transform 3s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }

        .spinner-wheel.spinning {
            transform: rotate(1800deg);
        }

        .spinner-center {
            width: 120px;
            height: 120px;
            background: var(--castle-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--magic-blue);
            font-size: 1rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .spin-btn {
            background: linear-gradient(135deg, var(--fantasy-purple), var(--pixie-pink));
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .spin-btn:hover {
            background: linear-gradient(135deg, var(--magic-blue), var(--fantasy-purple));
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
        }

        .spin-btn:active {
            transform: translateY(0);
        }

        .spin-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .spin-result {
            margin-top: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #F8F9FF, var(--fairy-cream));
            border-radius: 8px;
            border: 2px solid var(--fantasy-purple);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spin-result-text {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--fantasy-purple);
        }

        /* Storage Controls */
        .storage-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .storage-btn {
            background: var(--castle-blue);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .storage-btn:hover {
            background: var(--magic-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 81, 186, 0.4);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            header .logo {
                width: 100%;
            }

            .schedule-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="images/amusement-park-day-planner_logo.png" alt="Amusement Park Day Planner Logo" class="logo">
            <h1>Amusement Park Day Planner</h1>
        </div>
    </header>

    <div class="container">
        <!-- Left Panel: Filters & Rides -->
        <div class="left-panel">
            <!-- Park Selector -->
            <div class="filters">
                <h2 class="section-title">üé¢ Select Park</h2>
                <select id="park-selector" class="park-selector">
                    <option value="">Loading parks...</option>
                </select>
                <div id="park-info" class="park-info" style="margin-top: 1rem; font-size: 0.9rem; color: #666;"></div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <h2 class="section-title">üîç Filters</h2>
                <div class="filter-group">
                    <div class="filter-item">
                        <input type="checkbox" id="filter-open" value="open" checked>
                        <label for="filter-open">Open Rides</label>
                    </div>
                    <div class="filter-item">
                        <input type="checkbox" id="filter-closed" value="closed">
                        <label for="filter-closed">Closed Rides</label>
                    </div>
                </div>
            </div>

            <!-- Rides List -->
            <div class="rides-section">
                <h2 class="section-title">üé° Attractions</h2>
                <div class="rides-list" id="rides-list">
                    <!-- Rides will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Right Panel: Schedule & Spinner -->
        <div class="right-panel">
            <!-- Schedule Blocks -->
            <div class="schedule-container">
                <h2 class="section-title">üìÖ Your Schedule</h2>
                <div class="schedule-grid">
                    <div class="schedule-block" data-time="morning">
                        <div class="schedule-block-title">üåÖ Morning</div>
                        <div class="scheduled-rides" id="schedule-morning"></div>
                    </div>
                    <div class="schedule-block" data-time="midday">
                        <div class="schedule-block-title">‚òÄÔ∏è Midday</div>
                        <div class="scheduled-rides" id="schedule-midday"></div>
                    </div>
                    <div class="schedule-block" data-time="afternoon">
                        <div class="schedule-block-title">üå§Ô∏è Afternoon</div>
                        <div class="scheduled-rides" id="schedule-afternoon"></div>
                    </div>
                    <div class="schedule-block" data-time="evening">
                        <div class="schedule-block-title">üåô Evening</div>
                        <div class="scheduled-rides" id="schedule-evening"></div>
                    </div>
                </div>
            </div>

            <!-- Spinner Section -->
            <div class="spinner-section">
                <h2 class="section-title">üé∞ Ride Spinner</h2>
                <p style="margin-bottom: 1rem; color: #666;">Can't decide? Spin for your next ride from favorites!</p>
                
                <div class="spinner-wheel" id="spinner-wheel">
                    <div class="spinner-center" id="spinner-center">
                        Click Spin!
                    </div>
                </div>

                <button class="spin-btn" id="spin-btn">Spin for Next Ride</button>

                <div class="spin-result" id="spin-result">
                    <div class="spin-result-text" id="spin-result-text">
                        Add favorites ‚≠ê to start spinning!
                    </div>
                </div>

                <div class="storage-controls">
                    <button class="storage-btn" id="save-btn">üíæ Save Plan</button>
                    <button class="storage-btn" id="load-btn">üìÇ Load Plan</button>
                </div>

                <div style="margin-top: 1rem; font-size: 0.85rem; color: #666; text-align: center;">
                    Powered by <a href="https://queue-times.com/en-US" target="_blank" style="color: var(--pixie-pink); text-decoration: none; font-weight: bold;">Queue-Times.com</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===========================
        // DATA & STATE
        // ===========================
        const API_BASE = 'https://queue-times.com';
        
        let parks = [];
        let selectedPark = null;
        let rides = [];
        let ridesByLand = {};
        let favorites = new Set();
        let schedule = {
            morning: [],
            midday: [],
            afternoon: [],
            evening: []
        };

        // ===========================
        // INITIALIZATION
        // ===========================
        function init() {
            loadParks();
            setupFilters();
            setupDragAndDrop();
            setupSpinner();
            setupStorage();
        }

        // ===========================
        // API FUNCTIONS
        // ===========================
        async function loadParks() {
            try {
                console.log('Fetching parks...');
                
                let response;
                try {
                    response = await fetch(`${API_BASE}/parks.json`);
                } catch (corsError) {
                    console.log('Direct fetch failed, trying CORS proxy...');
                    response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(API_BASE + '/parks.json')}`);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Parks data loaded:', data);
                
                // Flatten park groups
                parks = [];
                data.forEach(group => {
                    if (group.parks && Array.isArray(group.parks)) {
                        group.parks.forEach(park => {
                            parks.push({
                                ...park,
                                groupName: group.name
                            });
                        });
                    }
                });
                
                // Sort alphabetically
                parks.sort((a, b) => a.name.localeCompare(b.name));
                
                console.log('Total parks loaded:', parks.length);
                renderParkSelector();
            } catch (error) {
                console.error('Error loading parks:', error);
                document.getElementById('park-selector').innerHTML = 
                    '<option value="">Error loading parks</option>';
                document.getElementById('park-info').innerHTML = 
                    `<div style="color: #d32f2f;">‚ö†Ô∏è Unable to load parks. Please refresh the page.</div>`;
            }
        }

        function renderParkSelector() {
            const selector = document.getElementById('park-selector');
            selector.innerHTML = '<option value="">-- Select a Park --</option>';
            selector.disabled = false;
            
            parks.forEach(park => {
                const option = document.createElement('option');
                option.value = park.id;
                option.textContent = `${park.name} (${park.country})`;
                selector.appendChild(option);
            });
            
            selector.addEventListener('change', (e) => {
                const parkId = e.target.value;
                if (parkId) {
                    loadParkData(parkId);
                } else {
                    rides = [];
                    ridesByLand = {};
                    renderRides();
                    document.getElementById('park-info').innerHTML = '';
                }
            });
        }

        async function loadParkData(parkId) {
            try {
                const park = parks.find(p => p.id == parkId);
                selectedPark = park;
                
                document.getElementById('park-info').innerHTML = 
                    `üìç ${park.name}<br>üåç ${park.country}`;
                
                document.getElementById('rides-list').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #666;">Loading rides...</div>';
                
                console.log('Fetching park data for:', park.name);
                
                let response;
                try {
                    response = await fetch(`${API_BASE}/parks/${parkId}/queue_times.json`);
                } catch (corsError) {
                    console.log('Direct fetch failed, trying CORS proxy...');
                    response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(API_BASE + '/parks/' + parkId + '/queue_times.json')}`);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Park data loaded:', data);
                
                // Process rides by land
                rides = [];
                ridesByLand = {};
                let rideId = 1;
                
                if (data.lands && Array.isArray(data.lands)) {
                    data.lands.forEach(land => {
                        if (land.rides && Array.isArray(land.rides)) {
                            ridesByLand[land.name] = [];
                            land.rides.forEach(ride => {
                                const rideObj = {
                                    id: rideId++,
                                    apiId: ride.id,
                                    name: ride.name,
                                    landName: land.name,
                                    isOpen: ride.is_open,
                                    waitTime: ride.wait_time,
                                    lastUpdated: ride.last_updated
                                };
                                rides.push(rideObj);
                                ridesByLand[land.name].push(rideObj);
                            });
                        }
                    });
                }
                
                // Handle rides not in a land
                if (data.rides && Array.isArray(data.rides) && data.rides.length > 0) {
                    ridesByLand['Other Attractions'] = [];
                    data.rides.forEach(ride => {
                        const rideObj = {
                            id: rideId++,
                            apiId: ride.id,
                            name: ride.name,
                            landName: 'Other Attractions',
                            isOpen: ride.is_open,
                            waitTime: ride.wait_time,
                            lastUpdated: ride.last_updated
                        };
                        rides.push(rideObj);
                        ridesByLand['Other Attractions'].push(rideObj);
                    });
                }
                
                console.log('Total rides loaded:', rides.length);
                console.log('Lands:', Object.keys(ridesByLand));
                
                if (rides.length === 0) {
                    throw new Error('No rides found');
                }
                
                renderRides();
                applyFilters();
                
                // Update last updated time
                if (rides.length > 0 && rides[0].lastUpdated) {
                    const lastUpdate = new Date(rides[0].lastUpdated);
                    document.getElementById('park-info').innerHTML += 
                        `<br><small>Last updated: ${lastUpdate.toLocaleTimeString()}</small>`;
                }
            } catch (error) {
                console.error('Error loading park data:', error);
                document.getElementById('rides-list').innerHTML = 
                    `<div style="text-align: center; padding: 2rem; color: #d32f2f;">
                        <strong>‚ö†Ô∏è Error loading rides</strong><br>
                        ${error.message}<br>
                        <small>Try selecting a different park</small>
                    </div>`;
            }
        }

        // ===========================
        // RENDER RIDES
        // ===========================
        function renderRides() {
            const ridesList = document.getElementById('rides-list');
            
            if (rides.length === 0) {
                ridesList.innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #666;">Select a park to see attractions</div>';
                return;
            }

            ridesList.innerHTML = '';

            // Render rides grouped by land
            Object.keys(ridesByLand).forEach(landName => {
                // Create land header
                const landHeader = document.createElement('div');
                landHeader.style.cssText = 'font-weight: bold; color: var(--magic-blue); padding: 0.75rem 0.5rem; margin-top: 1rem; border-bottom: 3px solid var(--fantasy-purple);';
                landHeader.textContent = landName;
                ridesList.appendChild(landHeader);
                
                // Render rides in this land
                ridesByLand[landName].forEach(ride => {
                    renderRideCard(ride, ridesList);
                });
            });

            // Setup favorite buttons
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavorite(parseInt(btn.dataset.rideId));
                });
            });
        }

        function renderRideCard(ride, container) {
            const rideCard = document.createElement('div');
            rideCard.className = `ride-card ${!ride.isOpen ? 'closed' : ''}`;
            rideCard.draggable = true;
            rideCard.dataset.rideId = ride.id;
            rideCard.dataset.isOpen = ride.isOpen;

            // Check if all wait times in the park are 0
            const allWaitTimesZero = rides.every(r => r.waitTime === 0 || r.waitTime === null || r.waitTime === undefined);

            let statusHTML = '';
            if (ride.isOpen) {
                let waitTimeHTML = '';
                
                // Only show wait time if it's provided and not all wait times are 0
                if (ride.waitTime !== null && ride.waitTime !== undefined && !allWaitTimesZero) {
                    let waitClass = 'medium';
                    let waitText = `${ride.waitTime} min`;
                    
                    if (ride.waitTime === 0) {
                        waitText = 'Walk-on';
                        waitClass = 'short';
                    } else if (ride.waitTime < 20) {
                        waitClass = 'short';
                    } else if (ride.waitTime < 45) {
                        waitClass = 'medium';
                    } else {
                        waitClass = 'long';
                    }
                    
                    waitTimeHTML = `<span class="wait-time ${waitClass}">‚è±Ô∏è ${waitText}</span>`;
                }
                
                statusHTML = `
                    <div class="ride-status">
                        <span class="status-badge open">Open</span>
                        ${waitTimeHTML}
                    </div>
                `;
            } else {
                statusHTML = `
                    <div class="ride-status">
                        <span class="status-badge closed">Closed</span>
                    </div>
                `;
            }

            rideCard.innerHTML = `
                <div class="ride-info">
                    <div class="ride-name">${ride.name}</div>
                    ${statusHTML}
                </div>
                <button class="favorite-btn ${favorites.has(ride.id) ? 'active' : 'inactive'}" 
                        data-ride-id="${ride.id}">
                    ${favorites.has(ride.id) ? '‚≠ê' : '‚òÜ'}
                </button>
            `;

            container.appendChild(rideCard);
        }

        // ===========================
        // FILTERS
        // ===========================
        function setupFilters() {
            const filterCheckboxes = document.querySelectorAll('.filter-item input[type="checkbox"]');
            
            filterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
        }

        function applyFilters() {
            const showOpen = document.getElementById('filter-open').checked;
            const showClosed = document.getElementById('filter-closed').checked;

            document.querySelectorAll('.ride-card').forEach(card => {
                const isOpen = card.dataset.isOpen === 'true';
                
                const shouldShow = (isOpen && showOpen) || (!isOpen && showClosed);
                
                if (shouldShow) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        // ===========================
        // FAVORITES
        // ===========================
        function toggleFavorite(rideId) {
            if (favorites.has(rideId)) {
                favorites.delete(rideId);
            } else {
                favorites.add(rideId);
            }
            renderRides();
            applyFilters();
        }

        // ===========================
        // DRAG AND DROP
        // ===========================
        function setupDragAndDrop() {
            const ridesList = document.getElementById('rides-list');

            // Drag start from rides list
            ridesList.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('ride-card')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('text/plain', e.target.dataset.rideId);
                }
            });

            ridesList.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('ride-card')) {
                    e.target.classList.remove('dragging');
                }
            });

            // Drop zones
            const scheduleBlocks = document.querySelectorAll('.schedule-block');

            scheduleBlocks.forEach(block => {
                block.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    block.classList.add('drag-over');
                });

                block.addEventListener('dragleave', (e) => {
                    if (e.target === block) {
                        block.classList.remove('drag-over');
                    }
                });

                block.addEventListener('drop', (e) => {
                    e.preventDefault();
                    block.classList.remove('drag-over');
                    
                    const rideId = parseInt(e.dataTransfer.getData('text/plain'));
                    const timeSlot = block.dataset.time;
                    
                    addRideToSchedule(rideId, timeSlot);
                });
            });
        }

        function addRideToSchedule(rideId, timeSlot) {
            const ride = rides.find(r => r.id === rideId);
            if (!ride) return;

            // Add to schedule (allow duplicates)
            schedule[timeSlot].push(ride);
            renderSchedule(timeSlot);
        }

        function renderSchedule(timeSlot) {
            const container = document.getElementById(`schedule-${timeSlot}`);
            container.innerHTML = '';

            // Check if all wait times are 0
            const allWaitTimesZero = rides.every(r => r.waitTime === 0 || r.waitTime === null || r.waitTime === undefined);

            schedule[timeSlot].forEach((ride, index) => {
                const rideEl = document.createElement('div');
                rideEl.className = 'scheduled-ride';
                
                let waitInfo = '';
                // Only show wait time if provided and not all wait times are 0
                if (ride.isOpen && ride.waitTime !== undefined && ride.waitTime !== null && !allWaitTimesZero) {
                    waitInfo = ` (‚è±Ô∏è ${ride.waitTime} min)`;
                } else if (!ride.isOpen) {
                    waitInfo = ' (Closed)';
                }
                
                rideEl.innerHTML = `
                    ${ride.name}${waitInfo}
                    <button class="scheduled-ride-delete" data-time="${timeSlot}" data-index="${index}" title="Remove from schedule">√ó</button>
                `;
                
                container.appendChild(rideEl);
            });

            // Setup delete buttons
            container.querySelectorAll('.scheduled-ride-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const timeSlot = btn.dataset.time;
                    const index = parseInt(btn.dataset.index);
                    removeRideFromSchedule(timeSlot, index);
                });
            });
        }

        function removeRideFromSchedule(timeSlot, index) {
            schedule[timeSlot].splice(index, 1);
            renderSchedule(timeSlot);
        }

        // ===========================
        // SPINNER
        // ===========================
        function setupSpinner() {
            const spinBtn = document.getElementById('spin-btn');
            const wheel = document.getElementById('spinner-wheel');
            
            spinBtn.addEventListener('click', () => {
                if (favorites.size === 0) {
                    document.getElementById('spin-result-text').textContent = 
                        'Please add some favorites ‚≠ê first!';
                    return;
                }

                spinBtn.disabled = true;
                wheel.classList.add('spinning');
                
                // Perform spin
                setTimeout(() => {
                    wheel.classList.remove('spinning');
                    
                    // Pick random favorite
                    const favoritesArray = Array.from(favorites);
                    const randomId = favoritesArray[Math.floor(Math.random() * favoritesArray.length)];
                    const selectedRide = rides.find(r => r.id === randomId);
                    
                    document.getElementById('spin-result-text').innerHTML = 
                        `üéâ <strong>${selectedRide.name}</strong> üéâ`;
                    
                    document.getElementById('spinner-center').textContent = selectedRide.name;
                    
                    spinBtn.disabled = false;
                }, 3000);
            });
        }

        // ===========================
        // LOCALSTORAGE
        // ===========================
        function setupStorage() {
            document.getElementById('save-btn').addEventListener('click', savePlan);
            document.getElementById('load-btn').addEventListener('click', loadPlan);
        }

        function savePlan() {
            const planData = {
                parkId: selectedPark.id,
                favorites: Array.from(favorites),
                schedule: {
                    morning: schedule.morning.map(r => r.id),
                    midday: schedule.midday.map(r => r.id),
                    afternoon: schedule.afternoon.map(r => r.id),
                    evening: schedule.evening.map(r => r.id)
                }
            };

            localStorage.setItem('parkPlan', JSON.stringify(planData));
            alert('‚úÖ Plan saved successfully!');
        }

        function loadPlan() {
            const saved = localStorage.getItem('parkPlan');
            if (!saved) {
                alert('‚ö†Ô∏è No saved plan found.');
                return;
            }

            const planData = JSON.parse(saved);
            
            // Restore favorites
            favorites = new Set(planData.favorites);
            
            // Restore schedule
            schedule = {
                morning: planData.schedule.morning.map(id => rides.find(r => r.id === id)).filter(Boolean),
                midday: planData.schedule.midday.map(id => rides.find(r => r.id === id)).filter(Boolean),
                afternoon: planData.schedule.afternoon.map(id => rides.find(r => r.id === id)).filter(Boolean),
                evening: planData.schedule.evening.map(id => rides.find(r => r.id === id)).filter(Boolean)
            };

            // Re-render everything
            renderRides();
            applyFilters();
            renderSchedule('morning');
            renderSchedule('midday');
            renderSchedule('afternoon');
            renderSchedule('evening');

            alert('‚úÖ Plan loaded successfully!');
        }

        // ===========================
        // START APP
        // ===========================
        init();
    </script>
</body>
</html>
